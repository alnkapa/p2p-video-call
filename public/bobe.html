<!DOCTYPE html>
<html lang="en">
  <body>
    <!-- interface_bob.html -->
    <div class="container">
      <h3>–ë–æ–±: –ü—Ä–∏–Ω–∏–º–∞—é—â–∏–π —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</h3>

      <div id="status">–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ SDP –æ—Ñ—Ñ–µ—Ä–∞...</div>

      <!-- –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∏–¥–µ–æ -->
      <div id="videoContainer" style="display: none">
        <h4>–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ (–í–∞—à–∞ –∫–∞–º–µ—Ä–∞):</h4>
        <video
          id="localVideo"
          autoplay
          muted
          playsinline
          style="width: 300px; max-width: 100%; border: 1px solid #ccc"
        ></video>
        <h4>–£–¥–∞–ª–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ (–ê–ª–∏—Å–∞):</h4>
        <video
          id="remoteVideo"
          autoplay
          playsinline
          style="width: 300px; max-width: 100%; border: 1px solid #ccc"
        ></video>
      </div>

      <textarea
        id="sdpOffer"
        placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ SDP –æ—Ñ—Ñ–µ—Ä –æ—Ç –ê–ª–∏—Å—ã..."
      ></textarea>
      <button onclick="pasteOffer()">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å SDP –æ—Ñ—Ñ–µ—Ä</button>

      <textarea
        id="sdpAnswer"
        readonly
        placeholder="SDP answer –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..."
      ></textarea>
      <button onclick="copyCompressedAnswer()" id="copyAnswerBtn" disabled>
        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å SDP answer
      </button>

      
      <div id="connectionStatus"></div>
    </div>

    <script>
      class SDPCompressor {
        // –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–∂–∞—Ç–∏–µ SDP
        static async compressSDP(sdpData) {
          try {
            // –ü—Ä–æ–±—É–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ API —Å–∂–∞—Ç–∏—è
            if (window.CompressionStream) {
              const encoded = new TextEncoder().encode(sdpData);

              // –°–æ–∑–¥–∞–µ–º ReadableStream –∏–∑ Uint8Array
              const readableStream = new ReadableStream({
                start(controller) {
                  controller.enqueue(encoded);
                  controller.close();
                },
              });

              const cs = new CompressionStream("deflate");
              const compressedStream = readableStream.pipeThrough(cs);

              const chunks = [];
              const reader = compressedStream.getReader();
              while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                chunks.push(value);
              }

              const compressedBlob = new Blob(chunks);
              const base64 = await this.blobToBase64(compressedBlob);
              return `compressed:${base64}`;
            }
          } catch (err) {
            console.warn("CompressionStream –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è:", err);
          }

          // Fallback: –ø—Ä–æ—Å—Ç–æ Base64
          const base64 = btoa(unescape(encodeURIComponent(sdpData)));
          return `base64:${base64}`;
        }

        // –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∏ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
        static async decompressSDP(compressedData) {
          if (compressedData.startsWith("compressed:")) {
            try {
              const base64 = compressedData.slice(11);
              const blob = await this.base64ToBlob(base64);

              const ds = new DecompressionStream("deflate");
              const decompressedStream = blob.stream().pipeThrough(ds);

              const chunks = [];
              const reader = decompressedStream.getReader();
              while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                chunks.push(value);
              }

              const array = new Uint8Array(
                await new Blob(chunks).arrayBuffer()
              );
              return new TextDecoder().decode(array);
            } catch (err) {
              console.warn("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏:", err);
            }
          }

          // Fallback: Base64
          if (compressedData.startsWith("base64:")) {
            const base64 = compressedData.slice(7);
            return decodeURIComponent(escape(atob(base64)));
          }

          // –ï—Å–ª–∏ –Ω–µ —Å–∂–∞—Ç–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
          return compressedData;
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
        static blobToBase64(blob) {
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(",")[1]);
            reader.readAsDataURL(blob);
          });
        }

        static base64ToBlob(base64) {
          const binary = atob(base64);
          const array = new Uint8Array(binary.length);
          for (let i = 0; i < binary.length; i++) {
            array[i] = binary.charCodeAt(i);
          }
          return new Blob([array]);
        }
      }

      let peerConnection;
      let localCandidates = [];
      let localStream = null;
      let resolveFunction;
      let rejectFunction;

      const promise = new Promise((resolve, reject) => {
        resolveFunction = resolve;
        rejectFunction = reject;
      });

      async function pasteOffer() {
        const compressedSdp = document.getElementById("sdpOffer").value;
        if (!compressedSdp) {
          alert("–í—Å—Ç–∞–≤—å—Ç–µ SDP –æ—Ñ—Ñ–µ—Ä –æ—Ç –ê–ª–∏—Å—ã");
          return;
        }
        const offerSdp = await SDPCompressor.decompressSDP(compressedSdp);

        document.getElementById("sdpOffer").value = offerSdp;
        document.getElementById("status").textContent =
          "üïê –ü—Ä–∏–º–µ–Ω—è–µ–º SDP –æ—Ñ—Ñ–µ—Ä...";

        const config = {
          iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "stun:stun1.l.google.com:19302" },
          ],
        };

        peerConnection = new RTCPeerConnection(config);
        
        // –°–æ–±–∏—Ä–∞–µ–º –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
        try {
          localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true,
          });

          // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
          const localVideo = document.getElementById("localVideo");
          localVideo.srcObject = localStream;

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          document.getElementById("videoContainer").style.display = "block";

          // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫–∏ –≤ peerConnection
          localStream.getTracks().forEach((track) => {
            peerConnection.addTrack(track, localStream);
          });

          console.log("‚úÖ –õ–æ–∫–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞");
        } catch (err) {
          console.log("‚ö†Ô∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω/–∫–∞–º–µ—Ä–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã: ", err);
          document.getElementById("status").textContent = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É";
          document.getElementById("connectionStatus").innerHTML +=
            "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É<br\>";
        }

        // –ñ–¥–µ–º –í–°–ï –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
        peerConnection.onicecandidate = (event) => {
          console.log("üü° onicecandidate –≤—ã–∑–≤–∞–Ω:", event.candidate);
          if (event.candidate) {
            localCandidates.push(event.candidate);
            document.getElementById(
              "status"
            ).textContent = `üïê –°–æ–±–∏—Ä–∞–µ–º —Å–µ—Ç–µ–≤—ã–µ –∞–¥—Ä–µ—Å–∞... (${localCandidates.length} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤)`;
            console.log("–ö–∞–Ω–¥–∏–¥–∞—Ç:", event.candidate.toJSON());
          } else {
            console.log("‚úÖ –í—Å–µ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã —Å–æ–±—Ä–∞–Ω—ã");
            document.getElementById(
              "status"
            ).textContent = `‚úÖ –í—Å–µ —Å–µ—Ç–µ–≤—ã–µ –∞–¥—Ä–µ—Å–∞ –≥–æ—Ç–æ–≤—ã! (${localCandidates.length} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤)`;
            //resolveFunction();
          }
        };

        peerConnection.onicecandidateerror = (event) => {
          console.error("–û—à–∏–±–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:", event);
          rejectFunction(event.errorText || "Unknown ICE error");
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥—è—â–µ–≥–æ –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫–∞
        peerConnection.ontrack = (event) => {
          console.log("‚úÖ –í—Ö–æ–¥—è—â–∏–π –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω:", event);
          const remoteVideo = document.getElementById("remoteVideo");

          if (event.streams && event.streams[0]) {
            remoteVideo.srcObject = event.streams[0];
          } else {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ –µ—Å–ª–∏ –Ω–µ –ø—Ä–∏—à–µ–ª –≤ events.streams
            const incomingStream = new MediaStream();
            incomingStream.addTrack(event.track);
            remoteVideo.srcObject = incomingStream;
          }          
          document.getElementById("connectionStatus").innerHTML +=
            "<p>‚úÖ –ü–æ–ª—É—á–µ–Ω –≤–∏–¥–µ–æ –ø–æ—Ç–æ–∫ –æ—Ç –ê–ª–∏—Å—ã</p>";
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        peerConnection.oniceconnectionstatechange = () => {
          const state = peerConnection.iceConnectionState;
          console.log("ICE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ:", state);
          const statusElem = document.getElementById("connectionStatus");

          if (state === "connected" || state === "completed") {            
            statusElem.innerHTML += "<p>‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!</p>";
            document.getElementById("status").textContent = "‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!";
             resolveFunction();
          } else if (state === "failed") {
            statusElem.innerHTML += "<p>‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å</p>";
            document.getElementById("status").textContent = "‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å";
          } else if (state === "disconnected") {            
            statusElem.innerHTML += "<p>‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ</p>";
            document.getElementById("status").textContent = "‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ";
          }
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
        peerConnection.onconnectionstatechange = () => {
          console.log("–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:", peerConnection.connectionState);
        };

        try {
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–æ—Ñ—Ñ–µ—Ä –ê–ª–∏—Å—ã)
          await peerConnection.setRemoteDescription({
            type: "offer",
            sdp: offerSdp,
          });

          // –°–æ–∑–¥–∞–µ–º answer
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);

          // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–±–æ—Ä–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
          await promise;

          document.getElementById("sdpAnswer").value = answer.sdp;
          document.getElementById("copyAnswerBtn").disabled = false;
          document.getElementById("connectionStatus").innerHTML +=
            "<p>üì§ SDP answer –≥–æ—Ç–æ–≤! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ê–ª–∏—Å–µ —á–µ—Ä–µ–∑ Telegram</p>";
          document.getElementById("status").textContent = "üì§ SDP answer –≥–æ—Ç–æ–≤! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ê–ª–∏—Å–µ —á–µ—Ä–µ–∑ Telegram";
          console.log("‚úÖ SDP answer —Å–æ–∑–¥–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ");
        } catch (err) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è SDP –æ—Ñ—Ñ–µ—Ä–∞:", err);
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è SDP –æ—Ñ—Ñ–µ—Ä–∞: " + err.message);
        }
      }

      async function copyCompressedAnswer() {
        try {
          const originalSDP = document.getElementById("sdpAnswer").value;
          const compressed = await SDPCompressor.compressSDP(originalSDP);
          await navigator.clipboard.writeText(compressed);
          alert("SDP answer —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!");
        } catch (err) {
          console.error("–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:", err);
          alert("–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: " + err.message);
        }
      }
    </script>
  </body>
</html>
