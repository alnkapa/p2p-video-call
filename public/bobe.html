<!DOCTYPE html>
<html lang="en">
  <body>
    <!-- interface_bob.html -->
    <div class="container">
      <h3>–ë–æ–±: –ü—Ä–∏–Ω–∏–º–∞—é—â–∏–π —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</h3>

      <textarea
        id="sdpOffer"
        placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ SDP –æ—Ñ—Ñ–µ—Ä –æ—Ç –ê–ª–∏—Å—ã..."
      ></textarea>
      <button onclick="pasteOffer()">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å SDP –æ—Ñ—Ñ–µ—Ä</button>

      <textarea
        id="sdpAnswer"
        readonly
        placeholder="SDP answer –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..."
      ></textarea>
      <button onclick="copyAnswer()" id="copyAnswerBtn" disabled>
        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å SDP answer
      </button>

      <div id="status">–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ SDP –æ—Ñ—Ñ–µ—Ä–∞...</div>
      <div id="connectionStatus"></div>
    </div>

    <script>
      let peerConnection;
      let localCandidates = [];

      async function pasteOffer() {
        const offerSdp = document.getElementById("sdpOffer").value;
        if (!offerSdp) {
          alert("–í—Å—Ç–∞–≤—å—Ç–µ SDP –æ—Ñ—Ñ–µ—Ä –æ—Ç –ê–ª–∏—Å—ã");
          return;
        }

        document.getElementById("status").textContent =
          "üïê –ü—Ä–∏–º–µ–Ω—è–µ–º SDP –æ—Ñ—Ñ–µ—Ä...";

        const config = {
          iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "stun:stun1.l.google.com:19302" },
          ],
        };

        peerConnection = new RTCPeerConnection(config);
        // –°–æ–∑–¥–∞–µ–º —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π Promise
        let resolveFunction;
        let rejectFunction;

        const promise = new Promise((resolve, reject) => {
          resolveFunction = resolve;
          rejectFunction = reject;
        });

        // –°–æ–±–∏—Ä–∞–µ–º –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true,
          });
          stream.getTracks().forEach((track) => {
            peerConnection.addTrack(track, stream);
          });
        } catch (err) {
          console.log("‚ö†Ô∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω/–∫–∞–º–µ—Ä–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã: ", err);
        }

        // –ñ–¥–µ–º –í–°–ï –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            localCandidates.push(event.candidate);
            document.getElementById(
              "status"
            ).textContent = `üïê –°–æ–±–∏—Ä–∞–µ–º —Å–µ—Ç–µ–≤—ã–µ –∞–¥—Ä–µ—Å–∞... (${localCandidates.length} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤)`;
          } else {
            document.getElementById(
              "status"
            ).textContent = `‚úÖ –í—Å–µ —Å–µ—Ç–µ–≤—ã–µ –∞–¥—Ä–µ—Å–∞ –≥–æ—Ç–æ–≤—ã! (${localCandidates.length} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤)`;
            resolveFunction();
          }
        };

        peerConnection.onicecandidateerror = (event) => {
          rejectFunction(event.message);
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥—è—â–µ–≥–æ –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫–∞
        peerConnection.ontrack = (event) => {
          const remoteVideo = document.createElement("video");
          remoteVideo.srcObject = event.streams[0];
          remoteVideo.autoplay = true;
          remoteVideo.controls = true;
          document.getElementById("connectionStatus").appendChild(remoteVideo);
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        peerConnection.oniceconnectionstatechange = () => {
          const state = peerConnection.iceConnectionState;
          console.log("ICE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ:", state);
          const statusElem = document.getElementById("connectionStatus");

          if (state === "connected" || state === "completed") {
            statusElem.innerHTML += "<p>‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!</p>";
          } else if (state === "failed") {
            statusElem.innerHTML += "<p>‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å</p>";
          }
        };

        try {
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–æ—Ñ—Ñ–µ—Ä –ê–ª–∏—Å—ã)
          await peerConnection.setRemoteDescription({
            type: "offer",
            sdp: offerSdp,
          });

          // –°–æ–∑–¥–∞–µ–º answer
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          await promise;
          console.log("end");
          document.getElementById("sdpAnswer").value = answer.sdp;
          document.getElementById("copyAnswerBtn").disabled = false;
          document.getElementById("connectionStatus").innerHTML =
            "<p>üì§ SDP answer –≥–æ—Ç–æ–≤! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ê–ª–∏—Å–µ —á–µ—Ä–µ–∑ Telegram</p>";          
        } catch (err) {
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è SDP –æ—Ñ—Ñ–µ—Ä–∞: " + err.message);
        }
      }

      function copyAnswer() {
        const answerText = document.getElementById("sdpAnswer");
        answerText.select();
        document.execCommand("copy");
      }
    </script>
  </body>
</html>
