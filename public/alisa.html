<!DOCTYPE html>
<html lang="en">
  <body>
    <div class="container">
      <h3>–ê–ª–∏—Å–∞: –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</h3>

      <button onclick="startConnection()">üé§ –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>

      <div id="status">–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ...</div>

      <textarea
        id="sdpOffer"
        readonly
        placeholder="SDP –æ—Ñ—Ñ–µ—Ä –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..."
      ></textarea>
      <button onclick="copyOffer()" id="copyBtn" disabled>
        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å SDP –æ—Ñ—Ñ–µ—Ä
      </button>

      <textarea
        id="sdpAnswer"
        placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ SDP answer –æ—Ç –ë–æ–±–∞..."
      ></textarea>
      <button onclick="pasteAnswer()">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å SDP answer</button>

      <div id="connectionStatus"></div>
    </div>

    <script>

      let peerConnection;
      let localCandidates = [];
      let iceGatheringTimeout;

      async function startConnection() {
        console.log("üü¢ –ù–∞—á–∏–Ω–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...");
        document.getElementById("status").textContent =
          "üïê –°–æ–∑–¥–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...";

        try {
          const config = {
            iceServers: [
              { urls: "stun:stun.l.google.com:19302" },
              { urls: "stun:stun1.l.google.com:19302" },
            ],
            iceCandidatePoolSize: 10,
          };

          peerConnection = new RTCPeerConnection(config);
          console.log("‚úÖ RTCPeerConnection —Å–æ–∑–¥–∞–Ω");

          // –°–æ–∑–¥–∞–µ–º —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π Promise
          let resolveFunction;
          let rejectFunction;

          const promise = new Promise((resolve, reject) => {
            resolveFunction = resolve;
            rejectFunction = reject;
          });
          await setupConnectionHandlers(resolveFunction, rejectFunction);

          // –°–æ–±–∏—Ä–∞–µ–º –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫ (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: true,
            });
            stream.getTracks().forEach((track) => {
              peerConnection.addTrack(track, stream);
            });
          } catch (err) {
            console.log("‚ö†Ô∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω/–∫–∞–º–µ—Ä–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã: ", err);
          }
          // –°–æ–∑–¥–∞–µ–º –æ—Ñ—Ñ–µ—Ä —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–æ–≤
          await createAndDisplayOffer();
          await promise;
          console.log("end");
          displayCurrentOffer();
        } catch (err) {
          console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:", err);
          document.getElementById("status").textContent =
            "‚ùå –û—à–∏–±–∫–∞: " + err.message;
        }
      }

      async function setupConnectionHandlers(resolveFunction, rejectFunction) {        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
        peerConnection.onicecandidate = (event) => {
          console.log("üü° onicecandidate –≤—ã–∑–≤–∞–Ω:", event.candidate);
          if (event.candidate) {
            localCandidates.push(event.candidate);
            document.getElementById(
              "status"
            ).textContent = `üïê –°–æ–±–∏—Ä–∞–µ–º —Å–µ—Ç–µ–≤—ã–µ –∞–¥—Ä–µ—Å–∞... (${localCandidates.length} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤)`;

            console.log("–ö–∞–Ω–¥–∏–¥–∞—Ç:", event.candidate.toJSON());
          } else {
            console.log("‚úÖ –í—Å–µ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã —Å–æ–±—Ä–∞–Ω—ã");
            document.getElementById(
              "status"
            ).textContent = `‚úÖ –í—Å–µ —Å–µ—Ç–µ–≤—ã–µ –∞–¥—Ä–µ—Å–∞ –≥–æ—Ç–æ–≤—ã! (${localCandidates.length} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤)`;
            resolveFunction();
          }
        };

        peerConnection.onicecandidateerror = (event) => {
          rejectFunction(event.message);
        };
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥—è—â–µ–≥–æ –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫–∞
        peerConnection.ontrack = (event) => {
          console.log("‚úÖ –í—Ö–æ–¥—è—â–∏–π –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω:", event);
          const remoteVideo = document.createElement("video");
          remoteVideo.srcObject = event.streams[0];
          remoteVideo.autoplay = true;
          remoteVideo.controls = true;
          remoteVideo.style.width = "100%";
          remoteVideo.style.maxWidth = "400px";
          document.getElementById("connectionStatus").appendChild(remoteVideo);
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        peerConnection.oniceconnectionstatechange = () => {
          const state = peerConnection.iceConnectionState;
          console.log("ICE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ:", state);
          const statusElem = document.getElementById("connectionStatus");

          if (state === "connected" || state === "completed") {
            statusElem.innerHTML += "<p>‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!</p>";
          } else if (state === "failed") {
            statusElem.innerHTML += "<p>‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å</p>";
          }
        };

      }

      async function createAndDisplayOffer() {
        try {
          console.log("üü° –°–æ–∑–¥–∞–µ–º –æ—Ñ—Ñ–µ—Ä...");
          const offer = await peerConnection.createOffer();
          console.log("‚úÖ –û—Ñ—Ñ–µ—Ä —Å–æ–∑–¥–∞–Ω");
          await peerConnection.setLocalDescription(offer);
          console.log("‚úÖ Local description —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");          
        } catch (err) {
          console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ñ—Ñ–µ—Ä–∞:", err);
          document.getElementById("status").textContent =
            "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ñ—Ñ–µ—Ä–∞";
        }
      }

      function displayCurrentOffer() {
        const currentSdp = peerConnection.localDescription.sdp;
        document.getElementById("sdpOffer").value = currentSdp;
        document.getElementById("copyBtn").disabled = false;

        document.getElementById(
          "connectionStatus"
        ).innerHTML = `<p>üì§ SDP –æ—Ñ—Ñ–µ—Ä –≥–æ—Ç–æ–≤! (${localCandidates.length} ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤)</p>
                       <p>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ë–æ–±—É —á–µ—Ä–µ–∑ Telegram</p>`;

        console.log("‚úÖ SDP –æ—Ñ—Ñ–µ—Ä –æ—Ç–æ–±—Ä–∞–∂–µ–Ω");
      }

      async function copyOffer() {
        const offerText = document.getElementById("sdpOffer").value;
        try {
          await navigator.clipboard.writeText(offerText);
          alert("SDP –æ—Ñ—Ñ–µ—Ä —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –ë–æ–±—É –≤ Telegram.");
        } catch (err) {
          const offerTextarea = document.getElementById("sdpOffer");
          offerTextarea.select();
          document.execCommand("copy");
          alert("SDP –æ—Ñ—Ñ–µ—Ä —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –ë–æ–±—É –≤ Telegram.");
        }
      }

      async function pasteAnswer() {
        const answerSdp = document.getElementById("sdpAnswer").value;
        if (!answerSdp) {
          alert("–í—Å—Ç–∞–≤—å—Ç–µ SDP answer –æ—Ç –ë–æ–±–∞");
          return;
        }

        try {
          await peerConnection.setRemoteDescription({
            type: "answer",
            sdp: answerSdp,
          });
          document.getElementById("connectionStatus").innerHTML +=
            "<p>‚úÖ SDP answer –ø—Ä–∏–º–µ–Ω–µ–Ω! –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...</p>";
          console.log("‚úÖ Remote description —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");
        } catch (err) {
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è SDP answer: " + err.message);
          console.error("‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ remote description:", err);
        }
      }
    </script>
  </body>
</html>
